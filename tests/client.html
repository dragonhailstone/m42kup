<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<title>m42kup.js client-side test page</title>
		<script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
		<script src="https://cdn.jsdelivr.net/highlight.js/latest/highlight.min.js"></script>
		<script src="../dist/m42kup.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/latest/styles/darcula.min.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
		<style>
			* {
				box-sizing: border-box;
			}

			body {
				padding: 15px;
				font: 16px Roboto, sans-serif;
				font-weight: 400;
				-webkit-font-smoothing: antialiased;
				color: #5f6368;
				line-height: 1.5;
				word-break: normal;
				word-wrap: break-word;
			}

			h1, h2, h3, h4, h5, h6 {
				font-weight: 400;
				line-height: 1.2;
				color: #202124;
			}

			a, b, strong, input, textarea, th {
				color: #202124;
			}

			pre, code {
				font-family: 'Roboto Mono', monospace;
				background-color: #eee;
				white-space: pre-wrap;
				word-break: break-all;
				tab-size: 4;
			}

			pre {
				padding: 6px;
			}

			code {
				font-size: .85em;
			}

			pre code {
				background-color: unset;
			}

			blockquote {
				margin: 1em 0;
				padding: .5em 20px;
				border-left: 5px #202124 solid;
				background-color: #f7f7f7;
			}

			#input {
				width: 100%;
				height: 200px;
				font-family: 'Roboto Mono', monospace;
				padding: 1em;
				border: 1px #5f6368 solid;
				resize: vertical;
			}

			#output {
				border: 1px #ccc solid;
				padding: 10px;
			}

			.m42kup-error {
				color: red;
				border: 1px red solid;
				padding: 0 .2em;
			}

			.katex {
				color: #202124;
			}

			/* m42khl */
			.m42khl {
				color: #222;
			}

			.m42khl-tx {
				
			}

			.m42khl-lbm {
				color: #d73a49;
				font-weight: bold;
			}

			.m42khl-tn {
				color: #d73a49;
				font-weight: bold;
			}

			.m42khl-sp {
				color: #d73a49;
				font-weight: bold;
			}

			.m42khl-rbm {
				color: #d73a49;
				font-weight: bold;
			}

			.m42khl-vbt {
				color: #6a737d;
			}

			.m42khl-mrbm {
				font-weight: bold;
				color: red;
				background-color: rgba(255, 0, 0, .2);
			}
		</style>
	</head>
	<body>
		<h1><code>m42kup.js</code> client-side test page</h1>
		<a href="https://github.com/logico-philosophical/m42kup">GitHub repo</a>
		<h2>Input</h2>
		<textarea id="input" placeholder="input"></textarea>
		<h2>Highlighted input</h2>
		<pre id="input-highlighted" class="m42khl"></pre>
		<h2>Parse tree</h2>
		<pre id="output-pt"></pre>
		<h2>Abstract syntax tree</h2>
		<pre id="output-ast"></pre>
		<h2>Output HTML</h2>
		<pre id="output-html"></pre>
		<h2>Rendered output</h2>
		<div id="output"></div>
		<script>
			var tags = {};

			tags['highlight'] = tags[';;;'] = r => {
				if (r.type != 'text') {
					throw new TypeError('Non-text input');
				}

				var commonLangs = [
					'apache', 'bash', 'coffeescript', 'cpp', 'cs',
					'css', 'diff', 'http', 'ini', 'java',
					'javascript', 'json', 'makefile', 'xml', 'markdown',
					'nginx', 'objectivec', 'perl', 'php', 'python',
					'ruby', 'sql'
				];

				var trimmed = r.text.replace(/(^[ \t]*\n)|(\n[ \t]*$)/g, ''),
					highlighted = hljs.highlightAuto(trimmed, commonLangs).value;
				return {
					type: 'html',
					html: `<pre class="hljs"><code>${highlighted}\n</code></pre>`
				};
			};

			tags['math'] = tags['$'] = r => {
				if (r.type != 'text') {
					throw new TypeError(`Non-text input`);
				}
				var rendered = katex.renderToString(r.text, {
					throwOnError: false,
					displayMode: false,
					strict: 'error'
				});

				return {
					type: 'html',
					html: rendered
				};
			};

			tags['displaymath'] = tags['$$'] = r => {
				if (r.type != 'text') {
					throw new TypeError(`Non-text input`);
				}
				var rendered = katex.renderToString(r.text, {
					throwOnError: false,
					displayMode: true,
					strict: 'error'
				});

				return {
					type: 'html',
					html: rendered
				};
			};

			var options = {tags};
			m42kup.set(options);
			
			$ = q => document.querySelector(q);
			$('#input').addEventListener('input', () => {
				var pt = m42kup.parser.generateParseTreeFromInput($('#input').value);
				$('#input-highlighted').innerHTML = syntaxHighlight(pt) + '\n';
				$('#output-pt').innerText = JSON.stringify(pt);

				var ast = m42kup.parser.generateASTFromParseTree(pt);
				$('#output-ast').innerText = JSON.stringify(ast);
				
				var output = m42kup.render($('#input').value);
				$('#output-html').innerText = output;
				$('#output').innerHTML = output;
			});

			function syntaxHighlight(pt) {
				var output = [];

				function walkPT(pt) {
					for (var i = 0; i < pt.length; i++) {
						switch(pt[i].type) {
							case 'text':
								output.push({
									type: 'tx',
									data: pt[i].data
								});
								break;
							case 'element':
								output.push({
									type: 'lbm',
									data: pt[i].children[0].data
								});
								output.push({
									type: 'tn',
									data: pt[i].children[1].data
								});
								output.push({
									type: 'sp',
									data: pt[i].children[2].data
								});
								walkPT(pt[i].children.slice(3, -1));
								output.push({
									type: 'rbm',
									data: pt[i].children[pt[i].children.length - 1].data
								});
								break;
							case 'verbatim':
								output.push({
									type: 'vbt',
									data: pt[i].children.map(e => e.data)
											.join('')
								});
								break;
							case 'mismatched right boundary marker':
								output.push({
									type: 'mrbm',
									data: pt[i].data
								});
								break;
						}
					}
				}

				walkPT(pt);

				return output
						.map(e => `<span class="m42khl-${e.type}">${m42kup.converter.escapeHtml(e.data)}</span>`)
						.join('');
			}
		</script>
	</body>
</html>
